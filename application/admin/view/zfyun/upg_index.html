<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="https://www.layuicdn.com/layui/css/layui.css" />
  </head>

  <body>
  	<div class="">
  		<div class="layui-row">
		    <div class="layui-col-xs12">
		    	<a href="javascript:;" class="layui-btn layui-btn-sm bak_old"> 备份原文件</a>
          		<button class="layui-btn layui-btn-sm" onclick="zfAdminShow('添加','/admin/Zfupgrade/setting')">配置</button>


		    	<?php if($upg_msg['code']==1){ ?>
			    	<a href="javascript:;" class="layui-btn check_version">1.下载新版本(默认保存源文件)</a>
			    	<a href="javascript:;" class="layui-btn replace_all"> 2.更新全部文件</a>
			    	<i class="layui-icon layui-icon-tips" style="font-size: 20px; color: red;"></i> 
			    	发现新版本:{$upg_msg['msg']} (依次执行1.2操作)
		    	<?php }else{ ?>
		    		未发现新版本 当前版本:
		    		{$upg_msg['msg']|raw}
		    	<?php } ?>
		    	<!-- <a href="javascript:;" class="layui-btn yun_update"> 下载最新版本</a> -->
		    	<table class="layui-table" lay-skin="line" width="100%" border="1" cellpadding="0" cellspacing="0" style="table-layout:fixed"  lay-size="sm">
				  <colgroup>
				    <col width="50">
				    <col width="300">
				    <col width="350">
				    <col width="500">
				    <col width="250">
				    <col width="80">
				    <col width="100">
				  </colgroup> 
				  <thead>
				    <tr>
				      <th>ID</th>
				      <th>文件名</th>
				      <th>原文件路径(/)</th> 
				      <th>更新文件路径(/data/addons/zf_upgrade/data/system/new/)</th>
				      <th>MD5</th>
				      <th>是否修改</th>
				      <th>
				      	操作
				      </th>
				    </tr> 
				  </thead>
				  <tbody>
				  	<?php $i=0;  foreach($ret[1] as $k=>$vo){ ?> 
				    <tr> 
				      <td>{++$i}</td> 
				      <td>{$vo['name']}</td> 
				      <td>{$vo['path_new']}<br> 操作权限: <?php  if(is_file($vo['path_new'])){ echo posix_getpwuid(fileowner($vo['path_new']))['name'] == 'root'? 'root <span style="color:red">(权限不足,无法修改)</span>':posix_getpwuid(fileowner($vo['path_new']))['name']; } ?></td>
				      <td>{$vo['path_old']}<br> 操作权限: <?php echo posix_getpwuid(fileowner($vo['path_old']))['name'] == 'root'? 'root <span style="color:red">(权限不足,无法修改)</span>':posix_getpwuid(fileowner($vo['path_old']))['name']; ?></td>
				      <td>{$vo['md5']}</td>
				      <td>{$vo['is_xg']|raw}</td> 
				      <td>
				      	<?php if($vo['is_xg']!='未修改'){ ?>
				      		<a class="layui-btn layui-btn-xs replace_one" href="javascript:;" path_old="{$vo['path_old']}" path_new="{$vo['path_new']}"  >更新</a>
				      	<?php } ?>
				      </td> 
				    </tr>
				    <?php } ?>
				    <?php foreach($ret[2] as $k=>$vo){ ?>
				    <tr> 
				      <td>{++$i}</td> 
				      <td>{$vo['name']}</td> 
				      <td>{$vo['path_new']}<br> 操作权限: <?php echo posix_getpwuid(fileowner($vo['path_new']))['name'] == 'root'? 'root <span style="color:red">(权限不足,无法修改)</span>':posix_getpwuid(fileowner($vo['path_new']))['name']; ?></td>
				      <td>{$vo['path_old']}<br> </td>
				      <td>{$vo['md5']}</td>
				      <td>{$vo['is_xg']|raw}</td>
				      <td></td> 
				    </tr>
				    <?php } ?>

				  </tbody>
				</table>
		    </div>
		</div>
  	</div>

    <script src="https://www.layuicdn.com/layui/layui.js"></script>
  <script src="__STATIC__/system/common.js"></script>  

    <!--您的Layui代码start-->
    <script type="text/javascript">
    layui.use([ 'laypage', 'layer', 'table', 'upload', 'element'], function() {
      var $ = layui.$
      ,layer = layui.layer //弹层
      ,table = layui.table //表格
      ,element = layui.element; //元素操作 等等...

      	$('.replace_one').on('click',function(){
      		var file_old = $(this).attr("path_old");
      		var file_new = $(this).attr("path_new");
      		var type = 'replace_one';
		    layer.confirm('确认替换？', {
		        btn: ['确认','取消'] //按钮
		    }, function(){
		        //执行删除操作
		        $.get("{:url('/admin/Zfupgrade/upgrade_act')}",{file_old,file_new,type},function(res){
		          if(res.result==1){
		            layer.msg(res.msg, {icon: 1});
		            setTimeout(function() {
		              location.reload(true);
		            }, 1000);
		          }else{
		            layer.msg(res.msg, {icon: 2});

		          }
		        },"json");

		    }, function(){
		          //取消的操作
		    });
      	})
      	$('.bak_old').on('click',function(){
      		var type = 'bak_old';
      		layer.load(1)
		    layer.confirm('确认备份？', {
		        btn: ['备份','取消'] //按钮
		    }, function(){
		        //执行删除操作
		        $.get("{:url('/admin/Zfupgrade/upgrade_act')}",{type},function(res){
		            layer.closeAll()
		          if(res.result==1){
		            layer.msg(res.msg, {icon: 1});
		            setTimeout(function() {
		              location.reload(true);
		            }, 5000);
		          }else{
		            layer.msg(res.msg, {icon: 2});

		          }
		        },"json");
		    }, function(){
		          //取消的操作
		    });
      	})

      	
      	$('.check_version').on('click',function(){
      		var index = layer.load(0, {shade: false});
      		var type = 'check_version';
      		layer.load(1)
	        $.get("{:url('/admin/Zfupgrade/upgrade_act')}",{type},function(res){
	          layer.close(index); 
	          if(res.result==1){
			    layer.msg(res.msg, {icon: 1});
	            setTimeout(function() {
	              location.reload(true);
	            }, 3000);

	          }else{
	            layer.msg(res.msg, {icon: 2});

	          }
	          layer.closeAll()
	        },"json");
      	})
      // 	$('.yun_update').on('click',function(){
      // 		var type = 'yun_update';
		    // layer.confirm('下载最新版本？', {
		    //     btn: ['下载','取消'] //按钮
		    // }, function(){
		    //     //执行删除操作
		    //     $.get("{:url('/admin/Zfupgrade/upgrade_act')}",{type},function(res){
		    //       if(res.result==1){
		    //         layer.msg(res.msg, {icon: 1});
		    //         setTimeout(function() {
		    //           location.reload(true);
		    //         }, 1000);
		    //       }else{
		    //     	console.log(res.msg);
		    //         layer.msg(res.msg, {icon: 2});

		    //       }
		    //     },"json");
		    // }, function(){
		    //       //取消的操作
		    // });
      // 	})
      	$('.replace_all').on('click',function(){
      		var type = 'replace_all';
      		layer.load(1)
		    layer.confirm('替换为最新文件?', {
		        btn: ['替换','取消'] //按钮
		    }, function(){
		        //执行删除操作
		        $.get("{:url('/admin/Zfupgrade/upgrade_act')}",{type},function(res){
		          if(res.result==1){
		            layer.msg(res.msg, {icon: 1});
		            setTimeout(function() {
		              location.reload(true);
		            }, 1000);
		          }else{
		            layer.msg(res.msg, {icon: 2});

		          }
		          layer.closeAll()
		        },"json");
		    }, function(){
		          //取消的操作
		    });
      	})

      	
      	
      		
      	

    });
    </script>
  </body>

</html>